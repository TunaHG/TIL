# TCL

> Transaction Control Language

## 트랜잭션 개요

* 트랜잭션

  * 데이터베이스의 논리적 연산단위
  * 밀접히 관련되어 분리될 수 없는 한 개 이상의 데이터베이스 조작
  * 분할할 수 없는 최소의 단위
  * 하나의 논리적인 작업 단위를 구성하는 세부적인 연산들의 집합

* 하나의 트랜잭션에는 하나 이상의  SQL문장이 포함

* **ALL OR NOTHING**, 전부 적용하거나 전부 취소

* TCL 명령어

  * **COMMIT**
    * 올바르게 반영된 데이터를 데이터베이스에 반영시키는 것
  * **ROLLBACK**
    * 트랜잭션 시작 이전의 상태로 되돌리는 것
  * **SAVEPOINT**

* 트랜잭션의 대상이 되는 SQL문은 UPDATE, INSERT, DELETE 등 데이터를 수정하는 DML문

* 트랜잭션의 특성

  ![sql가이드](image/SQL_170.jpg)

* **LOCKING**

  * 잠금, 기본적으로 트랜잭션이 수행하는 동안 특정 데이터에 대해서 다른 트랜잭션이 동시에 접근하지 못하도록 제한하는 기법
  * 잠금이 걸린 데이터는 잠금을 실행한 트랜잭션만 독점적으로 접근
  * 다른 트랜잭션으로부터 간섭이나 방해를 받지 않는 것이 보장
  * 잠금을 수행한 트랜잭션만이 해제 가능

## COMMIT

* 입력한 자료나 수정한 자료, 삭제한 자료에 대해서 전혀 문제가 없다고 판단되었을 경우 **트랜잭션을 완료하는 명령어**
* **COMMIT이나 ROLLBACK 이전의 데이터 상태**
  * 단지 메모리 BUFFER에만 영향을 받았기 때문에 데이터의 변경 이전 상태로 복구 가능
  * 현재 사용자는 SELECT 문장으로 결과를 확인 가능
  * 다른 사용자는 현재 사용자가 수행한 명령의 결과를 볼 수 없음
  * 변경된 행은 잠금(LOCKING)이 설정되어 다른 사용자가 변경할 수 없음
* **COMMIT 이후의 데이터 상태**
  * 데이터에 대한 변경 사항이 데이터베이스에 반영
  * 이전 데이터는 영원히 잃어버림
  * 모든 사용자가 결과를 확인 가능
  * 관련된 행에 대한 잠금(LOCKING)이 풀리고, 다른 사용자들이 행을 조작할 수 있게 됨
* Oracle
  * DML을 실행하는 경우 DBMS가 트랜잭션을 내부적으로 실행
  * DML문장 수행 후 사용자가 임의로 COMMIT 혹은 ROLLBACK을 수행해야 트랜잭션이 종료
  * *일부 툴에서는 AUTO COMMIT을 옵션으로 선택 가능*
* SQL Server
  * 기본적으로 AUTO COMMIT
  * DML 수행 후 사용자가 COMMIT 이나 ROLLBACK을 처리할 필요가 없음

### AUTO COMMIT

* SQL Server의 기본 방식
* DML, DDL을 수행할 때마다 DBMS가 트랜잭션을 컨트롤하는 방식
* 명령어가 성공적으로 수행되면 자동으로 COMMIT을 수행
  * 오류가 발생하면 자동으로 ROLLBACK을 수행

### 암시적 트랜잭션

* Oracle과 같은 방식으로 처리
* 트랜잭션의 시작은 DBMS가 처리하고 트랜잭션의 끝은 사용자가 명시적으로 COMMIT 또는 ROLLBACK으로 처리
* 인스턴스 단위 또는 세션 단위로 설정
  * 인스턴스 단위로 설정하려면 서버 속성 창의 연결화면에서 기본연결 옵션 중 암시적 트랜잭션에 체크
  * 세션 단위로 설정하기 위해서는 세션 옵션 중 SET IMPLICIT TRANSACTION ON을 사용

### 명시적 트랜잭션

* 트랜잭션의 시작과 끝을 모두 사용자가 명시적으로 지정하는 방식
* `BEGIN TRANSACTION(BEGIN TRAN도 가능)`으로 트랜재션을 시작
* `COMMIT TRANSACTION(TRANSACTION은 생략가능)` 또는 `ROLLBACK TRANSACTION(TRANSACTION은 생략가능)`으로 트랜잭션 종료

## ROLLBACK

* COMMIT 이전에 변경 사항을 취소하는 명령어
* ROLLBACK은 데이터 변경 사항이 취소되어 데이터의 이전상태로 복구되며,
  관련된 행에 대한 잠금(LOCKING)이 풀리고 다른 사용자들이 데이터 변경을 할 수 있게 됨
* SQL Server
  * AUTO COMMIT이 기본 방식
  * 임의적으로 ROLLBACK을 수행하려면 명시적으로 트랜잭션을 선언해야 함
* **ROLLBACK 후의 데이터 상태**
  * 데이터에 대한 변경사항은 취소
  * 이전 데이터는 다시 재저장
  * 관련된 행에 대한 잠금(LOCKING)이 풀리고, 다른 사용자들이 행을 조작 가능
* **COMMIT과 ROLLBACK을 사용함으로써의 효과**
  * 데이터 무결성 보장
  * 영구적인 변경을 하기 전에 데이터의 변경 사항 확인 가능
  * 논리적으로 연관된 작업을 그룹핑하여 처리 가능

## SAVEPOINT

* 저장점(SAVEPOINT)를 정의하면 ROLLBACK할 때 트랜잭션에 포함된 전체 작업을 롤백하는 것이 아니라 **현 시점에서 SAVEPOINT까지 트랜잭션의 일부만 롤백함**

* 복수의 저장점을 정의 가능

* 동일이름으로 저장점을 정의했을 때는 나중에 정의한 저장점이 유효

* 저장점 정의 방법

  ```SQL
  SAVEPOINT SVPT1;
  ```

* 저장점까지 ROLLBACK하는 방법

  ```SQL
  ROLLBACK TO SVPT1;
  ```

* 저장점 설정 이후에 있었던 데이터 변경에 대해서만 원래 데이터 상태로 되돌아감

* SQL Server는 `SAVE TRANSACTION`을 사용

* 미래 방향으로 되돌릴 수는 없음

  * 특정 저장점까지 롤백하면 그 저장점 이후에 설정한 저장점이 무효가 되기 때문